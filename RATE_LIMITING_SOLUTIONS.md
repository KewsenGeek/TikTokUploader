# Решения проблем с Rate Limiting и загрузкой видео

## Проблемы, которые были решены

### 1. Ошибка 429 (Too Many Requests)
**Симптомы:**
```
[FAIL] [CLIPBOARD] [USERS] failed to resolve @mellstroy: HTTPSConnectionPool(host='i.instagram.com', port=443): Max retries exceeded with url: /api/v1/users/mellstroy/usernameinfo/ (Caused by ResponseError('too many 429 error responses'))
```

**Причина:** Instagram API блокирует запросы из-за превышения лимитов запросов.

### 2. Ошибка загрузки видео
**Симптомы:**
```
[FAIL] [CLIPBOARD] [FAIL] clip upload error: Unknown ({'response': None})
```

**Причина:** `clip_upload` возвращает `None` в качестве response, что означает отсутствие ответа от Instagram API.

## Реализованные решения

### 1. Улучшенная система retry с экспоненциальным backoff

**Файл:** `uploader/rate_limiting_config.py`

- **Базовые задержки:** Настроены оптимальные задержки для разных операций
- **Retry логика:** До 3 попыток с экспоненциальным увеличением времени ожидания
- **Адаптация к времени суток:** Разные множители для дня/ночи
- **Специальная обработка 429:** Увеличенные задержки для rate limiting

### 2. Улучшенная обработка ошибок

**Файл:** `uploader/async_impl/instagrapi.py`

#### Для разрешения пользователей (`_build_usertags`):
- Retry до 3 попыток
- Специальная обработка ошибок 429 (до 3 минут ожидания)
- Пропуск несуществующих пользователей
- Остановка при challenge/verification

#### Для загрузки видео (`_sync_upload_impl`):
- Retry до 3 попыток для каждого видео
- Улучшенная валидация ответа от Instagram API
- Проверка на `None` response
- Специальная обработка rate limiting

#### Для поиска локаций (`_resolve_location`):
- Задержки перед каждым поиском
- Остановка при rate limiting
- Fallback на внешний геокодер

### 3. Конфигурация задержек

```python
# Базовые задержки (секунды)
BASE_DELAYS = {
    'user_resolution': (1.0, 3.0),      # Разрешение пользователей
    'location_search': (1.0, 3.0),      # Поиск локаций
    'upload_attempt': (3.0, 8.0),       # Загрузка видео
    'account_switch': (30.0, 120.0),    # Переключение аккаунтов
    'video_upload': (180.0, 420.0),     # Между видео
}

# Специальные задержки для 429 ошибок
RATE_LIMIT_DELAYS = {
    'user_resolution': (60, 180),       # 1-3 минуты
    'location_search': (30, 120),       # 30 сек - 2 минуты
    'upload_attempt': (120, 300),       # 2-5 минут
    'account_switch': (300, 900),       # 5-15 минут
}
```

## Как использовать

### 1. Автоматическое применение
Все улучшения применяются автоматически при использовании `instagrapi` загрузчика.

### 2. Мониторинг
В логах теперь отображается:
- Количество попыток для каждой операции
- Время ожидания перед retry
- Категория ошибки (rate_limit, challenge, network)
- Детальная информация о задержках

### 3. Настройка
Можно изменить параметры в `uploader/rate_limiting_config.py`:

```python
# Увеличить максимальное количество retry
RETRY_CONFIG = {
    'max_retries': 5,  # Вместо 3
    'base_backoff': 15,  # Вместо 10
    'max_backoff': 600,  # Вместо 300 (10 минут)
}
```

## Ожидаемые результаты

### 1. Снижение ошибок 429
- Увеличенные задержки между запросами
- Экспоненциальный backoff при ошибках
- Адаптация к времени суток

### 2. Улучшение успешности загрузки
- Retry механизм для временных сбоев
- Лучшая валидация ответов
- Обработка различных типов ошибок

### 3. Более стабильная работа
- Пропуск проблемных пользователей/локаций
- Остановка при критических ошибках
- Детальное логирование для диагностики

## Мониторинг и диагностика

### Логи для отслеживания:
```
[USERS] Resolving @username (attempt 1/3)
[USERS] Waiting 2.3s before retry for @username...
[USERS] [RATE_LIMIT] Rate limit for @username, waiting longer...
[UPLOAD] Waiting 5.7s before upload...
[RATE_LIMIT] Rate limit detected, waiting longer...
[RETRY] Upload attempt 2 failed: ...
```

### Ключевые метрики:
- Количество retry попыток
- Время ожидания между операциями
- Процент успешных загрузок
- Частота ошибок 429

## Дополнительные рекомендации

### 1. Для продакшена
- Увеличьте задержки между аккаунтами до 5-15 минут
- Используйте меньше одновременных аккаунтов
- Мониторьте логи на предмет частых 429 ошибок

### 2. Для тестирования
- Уменьшите задержки для быстрого тестирования
- Включите детальное логирование
- Тестируйте с небольшим количеством аккаунтов

### 3. При проблемах
- Проверьте логи на наличие паттернов ошибок
- Увеличьте задержки при частых 429
- Рассмотрите использование прокси для распределения нагрузки
