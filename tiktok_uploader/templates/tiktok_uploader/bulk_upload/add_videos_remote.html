{% extends 'tiktok_uploader/base.html' %}
{% load static %}

{% block title %}Add Videos - {{ task.name }} - TikTok Uploader{% endblock %}

{% block extra_css %}
<style>
    .video-preview {
        position: relative;
        display: inline-block;
        margin: 10px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        background: #f8f9fa;
    }
    
    .video-preview video {
        width: 150px;
        height: 267px;
        border-radius: 4px;
        object-fit: cover;
    }
    
    .video-preview .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .video-preview .remove-btn:hover {
        background: #dc3545;
    }
    
    .upload-zone {
        border: 3px dashed #0d6efd;
        border-radius: 10px;
        padding: 60px 20px;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .upload-zone:hover {
        background: #e7f1ff;
        border-color: #0a58ca;
    }
    
    .upload-zone.dragging {
        background: #cfe2ff;
        border-color: #0a58ca;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Progress Steps -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-fill text-center">
                        <div class="badge bg-success mb-2" style="font-size: 1rem;">✓ Параметры</div>
                        <div class="progress" style="height: 3px;">
                            <div class="progress-bar bg-success" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="px-2">→</div>
                    <div class="flex-fill text-center">
                        <div class="badge bg-primary mb-2" style="font-size: 1rem;">2. Видео</div>
                        <div class="progress" style="height: 3px;">
                            <div class="progress-bar bg-primary" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="px-2">→</div>
                    <div class="flex-fill text-center">
                        <div class="badge bg-secondary mb-2" style="font-size: 1rem;">3. Описания</div>
                        <div class="progress" style="height: 3px;">
                            <div class="progress-bar bg-secondary" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="px-2">→</div>
                    <div class="flex-fill text-center">
                        <div class="badge bg-secondary mb-2" style="font-size: 1rem;">4. Проверка</div>
                        <div class="progress" style="height: 3px;">
                            <div class="progress-bar bg-secondary" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-film"></i> Добавить видео</h2>
                    <p class="text-muted">Задача: <strong>{{ task.name }}</strong></p>
                </div>
            </div>

            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                
                <!-- Upload Zone -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('videoInput').click()">
                            <i class="bi bi-cloud-upload" style="font-size: 4rem; color: #0d6efd;"></i>
                            <h4 class="mt-3">Перетащите видео сюда или кликните для выбора</h4>
                            <p class="text-muted">Поддерживаются форматы: MP4, MOV, AVI</p>
                            <input type="file" id="videoInput" name="videos" multiple accept="video/*" 
                                   style="display: none;" onchange="handleFileSelect(event)">
                        </div>
                    </div>
                </div>
                
                <!-- Existing Videos -->
                {% if existing_videos %}
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-check-circle"></i> 
                            Загруженные видео ({{ existing_videos.count }})
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap">
                            {% for video in existing_videos %}
                            <div class="video-preview" id="video-{{ video.id }}">
                                <video src="{{ video.video_file.url }}" controls></video>
                                <div class="text-center mt-2">
                                    <small class="text-muted">{{ video.video_file.name|truncatechars:20 }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Preview Selected Videos -->
                <div class="card mb-4" id="previewCard" style="display: none;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-eye"></i> 
                            Выбранные видео (<span id="selectedCount">0</span>)
                        </h5>
                    </div>
                    <div class="card-body" id="previewContainer">
                        <!-- Previews will be added here by JavaScript -->
                    </div>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="d-flex justify-content-between">
                    <a href="{% url 'tiktok_uploader:bulk_upload_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Отмена
                    </a>
                    
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                        <i class="bi bi-arrow-right-circle"></i> Далее: Добавить описания
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedFiles = [];

// Drag and Drop handlers
const uploadZone = document.getElementById('uploadZone');

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragging');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragging');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragging');
    
    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('video/'));
    if (files.length > 0) {
        addFiles(files);
    }
});

function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    addFiles(files);
}

function addFiles(files) {
    selectedFiles = selectedFiles.concat(files);
    updatePreview();
    
    // Enable submit button
    document.getElementById('submitBtn').disabled = false;
    
    // Show preview card
    document.getElementById('previewCard').style.display = 'block';
}

function updatePreview() {
    const container = document.getElementById('previewContainer');
    const countSpan = document.getElementById('selectedCount');
    
    container.innerHTML = '';
    countSpan.textContent = selectedFiles.length;
    
    selectedFiles.forEach((file, index) => {
        const preview = document.createElement('div');
        preview.className = 'video-preview';
        
        const video = document.createElement('video');
        video.src = URL.createObjectURL(file);
        video.controls = true;
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '×';
        removeBtn.type = 'button';
        removeBtn.onclick = () => removeFile(index);
        
        const name = document.createElement('div');
        name.className = 'text-center mt-2';
        name.innerHTML = `<small class="text-muted">${file.name}</small>`;
        
        preview.appendChild(removeBtn);
        preview.appendChild(video);
        preview.appendChild(name);
        
        container.appendChild(preview);
    });
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    updatePreview();
    
    if (selectedFiles.length === 0) {
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('previewCard').style.display = 'none';
    }
}

// Update file input before submit
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    if (selectedFiles.length === 0 && {{ existing_videos.count }} === 0) {
        e.preventDefault();
        alert('Пожалуйста, выберите хотя бы одно видео');
        return;
    }
    
    // Create DataTransfer to update file input
    const dt = new DataTransfer();
    selectedFiles.forEach(file => dt.items.add(file));
    document.getElementById('videoInput').files = dt.files;
});
</script>
{% endblock %}



