{% extends "uploader/base.html" %}
{% load static %}

{% block title %}{{ task.name }} - Bulk Login - Instagram Uploader{% endblock %}

{% block extra_css %}
<style>
  .task-header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; }
  .status-badge { padding:.35rem .8rem; border-radius: 20px; font-weight: 600; font-size:.9rem; background: rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.2); }
  .progress-container { background: rgba(255,255,255,0.15); border-radius: 10px; padding:.8rem; margin-top:.8rem; }
  .progress-enhanced { height: 10px; border-radius: 6px; background: rgba(255,255,255,0.25); overflow: hidden; }
  .progress-bar-enhanced { height: 100%; background: linear-gradient(90deg, #28a745, #34ce57); transition: width .5s ease; }
  .data-section { background: var(--apple-card, white); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e9ecef; }
  .data-header { background: #f8f9fa; padding: 1rem 1.5rem; border-bottom: 1px solid #e9ecef; display:flex; justify-content:space-between; align-items:center; }
  .log-container { background: #1e1e1e; color: #f8f8f8; font-family: 'SF Mono','Monaco','Inconsolata','Roboto Mono',monospace; padding: 1rem; max-height: 600px; overflow-y: auto; border-radius:8px; border:1px solid #333; }
  .logs-nav .nav-link { border: none; padding: .85rem 1.2rem; color:#495057; font-weight:500; }
  .logs-nav .nav-link.active { color:#4facfe; border-bottom:3px solid #4facfe; }
</style>
{% endblock %}

{% block content %}
<div class="task-header">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h3 class="mb-1">{{ task.name }}</h3>
      <div class="d-flex align-items-center gap-2">
        <span class="status-badge">{{ task.status }}</span>
        <small class="text-white-75">Created {{ task.created_at|date:"M d, Y H:i" }}</small>
      </div>
      <div class="progress-container">
        <div class="progress-enhanced"><div id="progressBar" class="progress-bar-enhanced" style="width: {{ task.get_completion_percentage }}%"></div></div>
        <div class="mt-1" id="progressText"><small>{{ task.get_completed_count }} of {{ task.get_total_count }} accounts completed ({{ task.get_completion_percentage }}%)</small></div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <a href="{% url 'bulk_login_list' %}" class="btn btn-light">Back</a>
      {% if task.status == 'PENDING' %}
      <a href="{% url 'start_bulk_login' task_id=task.id %}" class="btn btn-success"><i class="bi bi-play-circle me-2"></i>Start</a>
      {% endif %}
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-6">
    <div class="data-section">
      <div class="data-header"><h5 class="m-0"><i class="bi bi-people me-2"></i>Accounts ({{ accounts|length }})</h5></div>
      <div class="table-responsive">
        <table class="table mb-0">
          <thead><tr><th>Account</th><th>Status</th><th>Proxy</th></tr></thead>
          <tbody>
            {% for account_task in accounts %}
            <tr>
              <td>{{ account_task.account.username }}</td>
              <td>{{ account_task.status }}</td>
              <td>{% if account_task.proxy %}{{ account_task.proxy.host }}:{{ account_task.proxy.port }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="data-section">
      <div class="data-header"><h5 class="m-0"><i class="bi bi-terminal me-2"></i>Logs</h5></div>
      <div class="logs-nav px-3 pt-2">
        <ul class="nav nav-tabs border-0" id="loginLogTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="main-log-tab" data-bs-toggle="tab" data-bs-target="#main-log" type="button" role="tab" aria-controls="main-log" aria-selected="true">
              <i class="bi bi-list-ul"></i> Main Log
            </button>
          </li>
          {% for account_task in accounts %}
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="account-{{ account_task.id }}-tab" data-bs-toggle="tab" data-bs-target="#account-{{ account_task.id }}" type="button" role="tab" aria-controls="account-{{ account_task.id }}" aria-selected="false">
              <i class="bi bi-person"></i> {{ account_task.account.username }}
            </button>
          </li>
          {% endfor %}
        </ul>
      </div>
      <div class="tab-content p-3">
        <div class="tab-pane fade show active" id="main-log" role="tabpanel" aria-labelledby="main-log-tab">
          <div class="log-container"><div id="logs">{{ task.log|default:"No logs yet..." }}</div></div>
        </div>
        {% for account_task in accounts %}
        <div class="tab-pane fade" id="account-{{ account_task.id }}" role="tabpanel" aria-labelledby="account-{{ account_task.id }}-tab">
          <div class="log-container"><div id="account-logs-{{ account_task.id }}">{{ account_task.log|default:"No logs yet..." }}</div></div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'uploader/js/logs.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // derive account ids
    const tabButtons = document.querySelectorAll('button[id^="account-"][id$="-tab"]');
    const accountTaskIds = Array.from(tabButtons).map(btn => { try { return parseInt(btn.id.replace('account-','').replace('-tab',''), 10);} catch(e){return NaN;} }).filter(Number.isFinite);
    // setup main log updater
    setupLogUpdater('{% url "bulk_login_logs" task_id=task.id %}', 2000);
    // per-account
    accountTaskIds.forEach(function(accountId){
      const url = '{% url "bulk_login_logs" task_id=task.id %}' + '?account_id=' + accountId;
      setupLogUpdater(url, 2000, 'account-logs-' + accountId);
    });
    // progress updater
    function updateTaskProgress(){
      fetch('{% url "bulk_login_logs" task_id=task.id %}').then(r=>r.json()).then(data=>{
        if (typeof data.completion_percentage !== 'undefined'){
          const pb = document.getElementById('progressBar'); if (pb) pb.style.width = data.completion_percentage + '%';
          const pt = document.getElementById('progressText'); if (pt) pt.textContent = `${data.completed_count} of ${data.total_count} accounts completed (${data.completion_percentage}%)`;
        }
      }).catch(()=>{});
    }
    setInterval(updateTaskProgress, 3000);
  });
</script>
{% endblock %}
