{% extends 'uploader/base.html' %}

{% block title %}Avatar Task #{{ task.id }} - Instagram Uploader{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <a href="{% url 'avatar_task_list' %}" class="text-decoration-none"><i class="bi bi-arrow-left"></i> Back to Tasks</a>
    <h2 class="mb-0 mt-2">Avatar Task #{{ task.id }}</h2>
  </div>
  <div>
    {% if task.status == 'PENDING' %}
      <a href="{% url 'start_avatar_task' task.id %}" class="btn btn-success"><i class="bi bi-play-fill"></i> Start</a>
    {% endif %}
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Task Info</span>
      </div>
      <div class="card-body">
        <div class="mb-2"><strong>Status:</strong> <span class="badge text-bg-secondary">{{ task.status }}</span></div>
        <div class="mb-2"><strong>Strategy:</strong> {{ task.strategy }}</div>
        <div class="mb-2"><strong>Delay:</strong> {{ task.delay_min_sec }} - {{ task.delay_max_sec }} sec</div>
        <div class="mb-2"><strong>Concurrency:</strong> {{ task.concurrency }}</div>
        <div class="mb-2"><strong>Created:</strong> {{ task.created_at|date:'Y-m-d H:i' }}</div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-header">Images</div>
      <div class="card-body">
        {% if images %}
          <ul class="list-unstyled mb-0">
            {% for img in images %}
              <li class="mb-1">#{{ img.id }} â€¢ uploaded {{ img.uploaded_at|date:'Y-m-d H:i' }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">No images</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card mt-3">
  <div class="card-header">Accounts</div>
  <div class="card-body">
    {% if accounts %}
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Account</th>
            <th>Status</th>
            <th>Proxy</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody>
          {% for a in accounts %}
          <tr>
            <td>{{ a.account.username }}</td>
            <td><span class="badge text-bg-secondary">{{ a.status }}</span></td>
            <td>{% if a.proxy %}{{ a.proxy.host }}:{{ a.proxy.port }}{% else %}-{% endif %}</td>
            <td>{{ a.completed_at|default:'-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="text-muted">No accounts assigned</div>
    {% endif %}
  </div>
</div>

<div class="card mt-3">
  <div class="card-header">Logs</div>
  <div class="card-body">
    <pre id="task-log" class="mb-0" style="white-space: pre-wrap; max-height: 50vh; overflow:auto;">{{ task.log }}</pre>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const logEl = document.getElementById('task-log');
  const taskId = {{ task.id }};
  let last = '';
  function fetchLogs(){
    fetch('{% url 'avatar_task_logs' task.id %}')
      .then(r => r.json())
      .then(data => {
        if (!data) return;
        const txt = data.log || '';
        if (txt !== last){
          const atBottom = (logEl.scrollTop + logEl.clientHeight) >= (logEl.scrollHeight - 10);
          logEl.textContent = txt;
          if (atBottom){
            logEl.scrollTop = logEl.scrollHeight;
          }
          last = txt;
        }
      })
      .catch(()=>{});
  }
  setInterval(fetchLogs, 1500);
})();
</script>
{% endblock %} 