{% extends "base.html" %}
{% load static %}

{% block title %}Error Logs - System Monitoring{% endblock %}

{% block extra_css %}
<style>
    .log-entry {
        border-left: 4px solid #6c757d;
        transition: all 0.3s;
    }
    .log-entry.error { border-left-color: #dc3545; }
    .log-entry.warning { border-left-color: #ffc107; }
    .log-entry.info { border-left-color: #17a2b8; }
    
    .server-badge {
        font-family: 'Courier New', monospace;
        font-size: 0.8em;
    }
    
    .log-timestamp {
        font-family: 'Courier New', monospace;
        font-size: 0.85em;
        color: #6c757d;
    }
    
    .log-message {
        font-family: 'Consolas', monospace;
        white-space: pre-wrap;
        word-break: break-all;
    }
    
    .error-stats {
        background: linear-gradient(45deg, #dc3545, #c82333);
        color: white;
    }
    
    .filter-controls {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .connection-error { background-color: #f8d7da; }
    .timeout-error { background-color: #fff3cd; }
    .unknown-error { background-color: #d1ecf1; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-exclamation-triangle text-danger"></i> Error Logs</h1>
        <div>
            <a href="{% url 'monitoring_dashboard' %}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-chart-line"></i> Back to Dashboard
            </a>
            <button class="btn btn-outline-success btn-sm" onclick="exportLogs()">
                <i class="fas fa-download"></i> Export Logs
            </button>
            <button class="btn btn-outline-info btn-sm" onclick="refreshLogs()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-circle"></i> {{ error }}
    </div>
    {% else %}

    <!-- Error Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card error-stats border-0 shadow-sm">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ total_errors }}</h3>
                    <small>Total Errors</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark border-0 shadow-sm">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ error_logs|length }}</h3>
                    <small>Displayed (Last 100)</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white border-0 shadow-sm">
                <div class="card-body text-center">
                    <h3 class="mb-0" id="unique-servers">0</h3>
                    <small>Affected Servers</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white border-0 shadow-sm">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ last_updated }}</h3>
                    <small>Last Updated</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="filter-controls">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Filter by Server</label>
                <select class="form-select" id="serverFilter" onchange="filterLogs()">
                    <option value="">All Servers</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Filter by Worker</label>
                <select class="form-select" id="workerFilter" onchange="filterLogs()">
                    <option value="">All Workers</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Filter by Error Type</label>
                <select class="form-select" id="errorTypeFilter" onchange="filterLogs()">
                    <option value="">All Types</option>
                    <option value="connection_error">Connection Errors</option>
                    <option value="timeout">Timeout Errors</option>
                    <option value="unknown">Unknown Errors</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Search Message</label>
                <input type="text" class="form-control" id="messageSearch" placeholder="Search in messages..." onkeyup="filterLogs()">
            </div>
        </div>
    </div>

    <!-- Error Logs -->
    <div class="row">
        <div class="col-12">
            {% if error_logs %}
            <div id="logs-container">
                {% for log in error_logs %}
                <div class="card log-entry {{ log.level|lower }} mb-2 shadow-sm" 
                     data-server="{{ log.server_ip }}" 
                     data-worker="{{ log.worker_name }}" 
                     data-error-type="{{ log.error_type|default:'unknown' }}">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <div>
                            <!-- Error Level Badge -->
                            {% if log.level == 'ERROR' %}
                            <span class="badge bg-danger">ERROR</span>
                            {% elif log.level == 'WARNING' %}
                            <span class="badge bg-warning text-dark">WARNING</span>
                            {% elif log.level == 'INFO' %}
                            <span class="badge bg-info">INFO</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ log.level|default:'UNKNOWN' }}</span>
                            {% endif %}
                            
                            <!-- Worker Name -->
                            <strong class="ms-2">{{ log.worker_name }}</strong>
                            
                            <!-- Error Type -->
                            {% if log.error_type %}
                            <span class="badge bg-light text-dark ms-2">{{ log.error_type }}</span>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex align-items-center">
                            <!-- Server IP -->
                            <span class="server-badge badge bg-dark me-2">
                                <i class="fas fa-server"></i> {{ log.server_ip }}
                            </span>
                            
                            <!-- Timestamp -->
                            <span class="log-timestamp">{{ log.timestamp }}</span>
                            
                            <!-- Actions -->
                            <div class="dropdown ms-2">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="copyServerInfo('{{ log.server_ip }}', '{{ log.worker_name }}')">
                                        <i class="fas fa-copy"></i> Copy Server Info
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="showSSHCommands('{{ log.server_ip }}', '{{ log.worker_name }}')">
                                        <i class="fas fa-terminal"></i> SSH Commands
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'worker_details' 0 %}".replace('0', '{{ log.worker_id|default:0 }}') target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Worker Details
                                    </a></li>
                                    {% if log.worker_url %}
                                    <li><a class="dropdown-item" href="{{ log.worker_url }}/api/v1/health" target="_blank">
                                        <i class="fas fa-heartbeat"></i> Check Health
                                    </a></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body py-2">
                        <div class="log-message">{{ log.message }}</div>
                        
                        {% if log.traceback %}
                        <details class="mt-2">
                            <summary class="text-muted">Show Traceback</summary>
                            <pre class="bg-light p-2 mt-2"><code>{{ log.traceback }}</code></pre>
                        </details>
                        {% endif %}
                        
                        <!-- Additional Error Context -->
                        {% if log.error_type == 'connection_error' %}
                        <div class="alert alert-danger py-1 mt-2 mb-0">
                            <small><i class="fas fa-exclamation-triangle"></i> 
                            <strong>Connection Error:</strong> Worker may be down or unreachable.
                            SSH to <code>{{ log.server_ip }}</code> to check service status.</small>
                        </div>
                        {% elif log.error_type == 'timeout' %}
                        <div class="alert alert-warning py-1 mt-2 mb-0">
                            <small><i class="fas fa-clock"></i> 
                            <strong>Timeout:</strong> Worker is slow to respond. Check system load on <code>{{ log.server_ip }}</code>.</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if total_errors > 100 %}
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i> 
                Showing last 100 errors out of {{ total_errors }} total. 
                Use filters to find specific errors or export full logs.
            </div>
            {% endif %}
            
            {% else %}
            <div class="alert alert-success text-center">
                <i class="fas fa-check-circle"></i> No errors found! All workers are running smoothly.
            </div>
            {% endif %}
        </div>
    </div>

    {% endif %}
</div>

<!-- SSH Commands Modal -->
<div class="modal fade" id="sshCommandsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Server Troubleshooting Commands</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Server:</strong> <span id="modalServerIP"></span><br>
                        <strong>Worker:</strong> <span id="modalWorkerName"></span>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard(document.getElementById('modalServerIP').textContent)">
                            <i class="fas fa-copy"></i> Copy IP
                        </button>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-terminal"></i> SSH Connection:</h6>
                        <pre><code>ssh user@<span class="modal-server-placeholder"></span></code></pre>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-cogs"></i> Service Management:</h6>
                        <pre><code># Check worker service status
sudo systemctl status bulk_worker_service

# View recent logs
sudo journalctl -u bulk_worker_service -n 50 --no-pager

# Restart service
sudo systemctl restart bulk_worker_service

# Follow logs in real-time
sudo journalctl -u bulk_worker_service -f</code></pre>
                    </div>
                    
                    <div class="alert alert-secondary">
                        <h6><i class="fas fa-chart-line"></i> System Diagnostics:</h6>
                        <pre><code># Check system resources
htop
df -h
free -h

# Check network connectivity
curl -I http://localhost:8088/api/v1/health

# Check process list
ps aux | grep python</code></pre>
                    </div>
                    
                    <div class="alert alert-success">
                        <h6><i class="fas fa-tools"></i> Worker-Specific Commands:</h6>
                        <pre><code># Check worker logs
tail -f /path/to/logs/worker_1.log

# Check deployment script
./deploy_production.sh status

# Restart specific worker
./deploy_production.sh restart</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allLogs = [];

document.addEventListener('DOMContentLoaded', function() {
    // Populate filter dropdowns and count unique servers
    populateFilters();
    updateUniqueServersCount();
});

function populateFilters() {
    const logs = document.querySelectorAll('.log-entry');
    const servers = new Set();
    const workers = new Set();
    
    logs.forEach(log => {
        servers.add(log.dataset.server);
        workers.add(log.dataset.worker);
    });
    
    // Populate server filter
    const serverFilter = document.getElementById('serverFilter');
    servers.forEach(server => {
        const option = document.createElement('option');
        option.value = server;
        option.textContent = server;
        serverFilter.appendChild(option);
    });
    
    // Populate worker filter
    const workerFilter = document.getElementById('workerFilter');
    workers.forEach(worker => {
        const option = document.createElement('option');
        option.value = worker;
        option.textContent = worker;
        workerFilter.appendChild(option);
    });
}

function updateUniqueServersCount() {
    const logs = document.querySelectorAll('.log-entry:not([style*="display: none"])');
    const servers = new Set();
    
    logs.forEach(log => {
        servers.add(log.dataset.server);
    });
    
    document.getElementById('unique-servers').textContent = servers.size;
}

function filterLogs() {
    const serverFilter = document.getElementById('serverFilter').value;
    const workerFilter = document.getElementById('workerFilter').value;
    const errorTypeFilter = document.getElementById('errorTypeFilter').value;
    const messageSearch = document.getElementById('messageSearch').value.toLowerCase();
    
    const logs = document.querySelectorAll('.log-entry');
    let visibleCount = 0;
    
    logs.forEach(log => {
        let show = true;
        
        // Server filter
        if (serverFilter && log.dataset.server !== serverFilter) {
            show = false;
        }
        
        // Worker filter
        if (workerFilter && log.dataset.worker !== workerFilter) {
            show = false;
        }
        
        // Error type filter
        if (errorTypeFilter && log.dataset.errorType !== errorTypeFilter) {
            show = false;
        }
        
        // Message search
        if (messageSearch && !log.textContent.toLowerCase().includes(messageSearch)) {
            show = false;
        }
        
        log.style.display = show ? 'block' : 'none';
        if (show) visibleCount++;
    });
    
    updateUniqueServersCount();
    
    // Update displayed count
    const displayedElement = document.querySelector('.bg-warning .card-body h3');
    if (displayedElement) {
        displayedElement.textContent = visibleCount;
    }
}

function refreshLogs() {
    window.location.reload();
}

function exportLogs() {
    // Create CSV export of visible logs
    const logs = document.querySelectorAll('.log-entry:not([style*="display: none"])');
    let csv = 'Timestamp,Level,Worker,Server IP,Error Type,Message\n';
    
    logs.forEach(log => {
        const timestamp = log.querySelector('.log-timestamp').textContent;
        const level = log.querySelector('.badge').textContent;
        const worker = log.dataset.worker;
        const server = log.dataset.server;
        const errorType = log.dataset.errorType;
        const message = log.querySelector('.log-message').textContent.replace(/"/g, '""');
        
        csv += `"${timestamp}","${level}","${worker}","${server}","${errorType}","${message}"\n`;
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `error_logs_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function copyServerInfo(serverIP, workerName) {
    const text = `Server: ${serverIP}\nWorker: ${workerName}\nSSH: ssh user@${serverIP}`;
    navigator.clipboard.writeText(text).then(() => {
        showToast('Server info copied to clipboard');
    });
}

function showSSHCommands(serverIP, workerName) {
    document.getElementById('modalServerIP').textContent = serverIP;
    document.getElementById('modalWorkerName').textContent = workerName;
    document.querySelectorAll('.modal-server-placeholder').forEach(el => {
        el.textContent = serverIP;
    });
    
    new bootstrap.Modal(document.getElementById('sshCommandsModal')).show();
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard');
    });
}

function showToast(message) {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = 'position-fixed top-0 end-0 m-3 alert alert-success alert-dismissible';
    toast.style.zIndex = '9999';
    toast.innerHTML = `${message}<button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>`;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}
</script>
{% endblock %}