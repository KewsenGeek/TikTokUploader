{% extends 'uploader/base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <h2>Bio Link Task #{{ task.id }}</h2>
  <div class="mb-3">
    <a href="{% url 'start_bio_task' task.id %}" class="btn btn-success" {% if task.status == 'RUNNING' %}disabled{% endif %}>Start</a>
    <a href="{% url 'bio_task_list' %}" class="btn btn-secondary">Back</a>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <p><strong>Status:</strong> {{ task.status }}</p>
      <p><strong>Link:</strong> <a href="{{ task.link_url }}" target="_blank">{{ task.link_url }}</a></p>
      <p><strong>Delays:</strong> {{ task.delay_min_sec }} - {{ task.delay_max_sec }} sec</p>
    </div>
  </div>

  <h4>Accounts</h4>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Username</th>
        <th>Status</th>
        <th>Proxy</th>
        <th>Started</th>
        <th>Completed</th>
      </tr>
    </thead>
    <tbody>
      {% for ta in accounts %}
      <tr>
        <td>{{ ta.account.username }}</td>
        <td>{{ ta.status }}</td>
        <td>{% if ta.proxy %}{{ ta.proxy.host }}:{{ ta.proxy.port }}{% else %}-{% endif %}</td>
        <td>{{ ta.started_at|default:"-" }}</td>
        <td>{{ ta.completed_at|default:"-" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h4>Logs</h4>
  <pre id="task-log" style="max-height: 360px; overflow:auto; background:#111; color:#0f0; padding:10px;">{{ task.log }}</pre>
</div>
<script>
  const POLL_URL = "{% url 'bio_task_logs' task.id %}";
  let lastLog = document.getElementById('task-log').textContent;
  setInterval(async () => {
    try {
      const res = await fetch(POLL_URL);
      const data = await res.json();
      if (data && data.log && data.log !== lastLog) {
        document.getElementById('task-log').textContent = data.log;
        lastLog = data.log;
      }
    } catch (e) {}
  }, 2000);
</script>
{% endblock %}
