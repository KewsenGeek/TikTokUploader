{% extends "uploader/base.html" %}

{% block title %}Калькулятор стоимости продвижения - Instagram и TikTok{% endblock %}

{% block content %}
<style>
        :root {
            --primary-color: #1a1a1a;
            --secondary-color: #333333;
            --accent-color: #ff6b35;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --dark-color: #1a1a1a;
            --light-color: #f8f9fa;
            --text-color: #333333;
            --border-color: #e9ecef;
        }
        
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 1400px;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            border-radius: 20px 20px 0 0;
            text-align: center;
            position: relative;
            min-height: 120px;
        }
        
        .header-section h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            max-width: 70%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .header-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            z-index: 10;
        }
        
        .stats-btn {
            background: var(--accent-color);
            border: 2px solid var(--accent-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stats-btn:hover {
            background: #e55a2b;
            border-color: #e55a2b;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }
        
        .tariffs-section {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        
        .tariffs-section h3 {
            color: var(--dark-color);
            text-align: center;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        
        .tariff-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid var(--accent-color);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .tariff-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }
        
        .tier-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .tier-1 { background: linear-gradient(135deg, var(--accent-color), #e55a2b); color: white; }
        .tier-2 { background: linear-gradient(135deg, var(--warning-color), #e0a800); color: white; }
        .tier-3 { background: linear-gradient(135deg, var(--danger-color), #c82333); color: white; }
        .tier-difficult { background: linear-gradient(135deg, var(--dark-color), #495057); color: white; }
        
        .form-section {
            padding: 2rem;
        }
        
        .form-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .form-card h4 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid var(--border-color);
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25);
        }
        
        .form-check-input:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn {
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), #e55a2b);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.6);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }
        
        .result-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .final-cost {
            background: linear-gradient(135deg, var(--accent-color), #e55a2b);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
        }
        
        .accordion-button {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .accordion-button:not(.collapsed) {
            background: linear-gradient(135deg, var(--accent-color), #e55a2b);
            color: white;
        }
        
        .country-select {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .country-option {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin: 0.25rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .country-option:hover {
            background-color: var(--light-color);
            transform: translateX(5px);
        }
        
        .country-option.selected {
            background-color: var(--accent-color);
            color: white;
            transform: translateX(5px);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        @media (max-width: 768px) {
            .main-container {
                margin: 1rem;
                border-radius: 15px;
            }
            
            .header-section {
                padding: 1.5rem 1rem;
                min-height: 100px;
            }
            
            .header-section h1 {
                font-size: 1.8rem;
                max-width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .header-controls {
                position: static;
                justify-content: center;
                margin-top: 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .stats-btn {
                font-size: 0.9rem;
                padding: 0.6rem 1.2rem;
            }
            
            .form-section {
                padding: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .header-section h1 {
                font-size: 1.5rem;
            }
            
            .header-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
</style>

<div class="container-fluid">
    <div class="main-container">
        <!-- Заголовок -->
        <div class="header-section">
            <!-- Элементы управления в шапке -->
            <div class="header-controls">
                <a href="{% url 'cabinet_agency_dashboard' %}" class="stats-btn">
                    <i class="bi bi-arrow-left"></i> Назад
                </a>
            </div>
            
            <h1><i class="bi bi-calculator"></i> Калькулятор стоимости продвижения</h1>
            <p class="lead mb-0">Instagram и TikTok - Агентские цены</p>
        </div>

        <!-- Тарифы -->
        <div class="tariffs-section">
            <h3><i class="bi bi-currency-exchange"></i> Тарифная сетка</h3>
            <div class="row">
                <div class="col-md-3">
                    <div class="tariff-card text-center">
                        <span class="tier-badge tier-1 mb-2">Tier 1</span>
                        <h5>Премиум страны</h5>
                        <p class="text-muted">США, Великобритания, Германия, Франция, Япония, Канада, Австралия, Нидерланды, Швеция, Швейцария, Норвегия, Дания, Финляндия, Австрия, Бельгия, Ирландия, Сингапур, Гонконг, Южная Корея, Новая Зеландия</p>
                        <div class="h4 text-primary">100%</div>
                        <small>Базовая цена</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="tariff-card text-center">
                        <span class="tier-badge tier-2 mb-2">Tier 2</span>
                        <h5>Развивающиеся страны</h5>
                        <p class="text-muted">Италия, Испания, Португалия, Греция, Польша, Чехия, Венгрия, Словакия, Словения, Эстония, Латвия, Литва, Бразилия, Индия, Россия, Мексика, Турция, Аргентина, Чили, Колумбия, Перу, Венесуэла, Уругвай, Эквадор, Боливия, Парагвай, ЮАР</p>
                        <div class="h4 text-warning">85%</div>
                        <small>-15% от базовой</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="tariff-card text-center">
                        <span class="tier-badge tier-3 mb-2">Tier 3</span>
                        <h5>Экономичные страны</h5>
                        <p class="text-muted">Нигерия, Кения, Гана, Уганда, Танзания, Эфиопия, Мозамбик, Зимбабве, Замбия, Малави, Ботсвана, Намибия, Вьетнам, Филиппины, Египет, Пакистан, Бангладеш, Шри-Ланка, Непал, Мьянма, Камбоджа, Лаос, Монголия</p>
                        <div class="h4 text-danger">70%</div>
                        <small>-30% от базовой</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="tariff-card text-center">
                        <span class="tier-badge tier-difficult mb-2">Сложные</span>
                        <h5>Сложные страны</h5>
                        <p class="text-muted">Афганистан, Иран, Ирак, Сирия, Ливан, Иордания, Палестина, Йемен, Оман, Кувейт, Катар, Бахрейн, ОАЭ, Саудовская Аравия, Украина</p>
                        <div class="h4 text-dark">100% + 30%</div>
                        <small>Сложная страна</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Форма расчета -->
        <div class="form-section">
            <form id="calcForm" class="form-card">
                <div class="row">
                    <!-- Левая колонка -->
                    <div class="col-lg-6">
                        <h4><i class="bi bi-eye"></i> Основные параметры</h4>
                        
                        <div class="mb-3">
                            <label for="views_mln" class="form-label">
                                <strong>Объем просмотров (млн)</strong>
                                <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" title="Минимальный объем: 15 млн просмотров"></i>
                            </label>
                            <input type="number" class="form-control" id="views_mln" name="views_mln" min="15" max="1000" step="1" value="15" required>
                            <input type="range" class="form-range mt-2" id="views_slider" min="15" max="1000" step="1" value="15">
                            <small class="text-muted">От 15 до 1000 млн просмотров</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><strong>Платформы</strong></label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="platform_instagram" name="platform_instagram" checked>
                                    <label class="form-check-label" for="platform_instagram">
                                        <i class="bi bi-instagram text-danger"></i> Instagram
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="platform_tiktok" name="platform_tiktok">
                                    <label class="form-check-label" for="platform_tiktok">
                                        <i class="bi bi-tiktok text-dark"></i> TikTok
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="platform_youtube_shorts" name="platform_youtube_shorts">
                                    <label class="form-check-label" for="platform_youtube_shorts">
                                        <i class="bi bi-youtube text-danger"></i> YouTube Shorts <span class="badge bg-warning">+15%</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="currency" class="form-label"><strong>Валюта</strong></label>
                            <select class="form-select" id="currency" name="currency">
                                <option value="RUB">Рубли (₽)</option>
                                <option value="USD">Доллары ($)</option>
                                <option value="EUR">Евро (€)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="countries" class="form-label"><strong>Выбор стран</strong></label>
                            <div class="country-select border rounded p-2">
                                <div class="mb-2">
                                    <strong class="text-primary">Tier 1 - Премиум страны</strong>
                                    <div class="country-option" data-country="USA" data-tier="1">🇺🇸 США</div>
                                    <div class="country-option" data-country="UK" data-tier="1">🇬🇧 Великобритания</div>
                                    <div class="country-option" data-country="DE" data-tier="1">🇩🇪 Германия</div>
                                    <div class="country-option" data-country="FR" data-tier="1">🇫🇷 Франция</div>
                                    <div class="country-option" data-country="JP" data-tier="1">🇯🇵 Япония</div>
                                    <div class="country-option" data-country="CA" data-tier="1">🇨🇦 Канада</div>
                                    <div class="country-option" data-country="AU" data-tier="1">🇦🇺 Австралия</div>
                                    <div class="country-option" data-country="NL" data-tier="1">🇳🇱 Нидерланды</div>
                                    <div class="country-option" data-country="SE" data-tier="1">🇸🇪 Швеция</div>
                                    <div class="country-option" data-country="CH" data-tier="1">🇨🇭 Швейцария</div>
                                    <div class="country-option" data-country="NO" data-tier="1">🇳🇴 Норвегия</div>
                                    <div class="country-option" data-country="DK" data-tier="1">🇩🇰 Дания</div>
                                    <div class="country-option" data-country="FI" data-tier="1">🇫🇮 Финляндия</div>
                                    <div class="country-option" data-country="AT" data-tier="1">🇦🇹 Австрия</div>
                                    <div class="country-option" data-country="BE" data-tier="1">🇧🇪 Бельгия</div>
                                    <div class="country-option" data-country="IE" data-tier="1">🇮🇪 Ирландия</div>
                                    <div class="country-option" data-country="SG" data-tier="1">🇸🇬 Сингапур</div>
                                    <div class="country-option" data-country="HK" data-tier="1">🇭🇰 Гонконг</div>
                                    <div class="country-option" data-country="KR" data-tier="1">🇰🇷 Южная Корея</div>
                                    <div class="country-option" data-country="NZ" data-tier="1">🇳🇿 Новая Зеландия</div>
                                </div>
                                <div class="mb-2">
                                    <strong class="text-warning">Tier 2 - Развивающиеся страны</strong>
                                    <div class="country-option" data-country="IT" data-tier="2">🇮🇹 Италия</div>
                                    <div class="country-option" data-country="ES" data-tier="2">🇪🇸 Испания</div>
                                    <div class="country-option" data-country="PT" data-tier="2">🇵🇹 Португалия</div>
                                    <div class="country-option" data-country="GR" data-tier="2">🇬🇷 Греция</div>
                                    <div class="country-option" data-country="PL" data-tier="2">🇵🇱 Польша</div>
                                    <div class="country-option" data-country="CZ" data-tier="2">🇨🇿 Чехия</div>
                                    <div class="country-option" data-country="HU" data-tier="2">🇭🇺 Венгрия</div>
                                    <div class="country-option" data-country="SK" data-tier="2">🇸🇰 Словакия</div>
                                    <div class="country-option" data-country="SI" data-tier="2">🇸🇮 Словения</div>
                                    <div class="country-option" data-country="EE" data-tier="2">🇪🇪 Эстония</div>
                                    <div class="country-option" data-country="LV" data-tier="2">🇱🇻 Латвия</div>
                                    <div class="country-option" data-country="LT" data-tier="2">🇱🇹 Литва</div>
                                    <div class="country-option" data-country="BR" data-tier="2">🇧🇷 Бразилия</div>
                                    <div class="country-option" data-country="IN" data-tier="2">🇮🇳 Индия</div>
                                    <div class="country-option" data-country="RU" data-tier="2">🇷🇺 Россия</div>
                                    <div class="country-option" data-country="MX" data-tier="2">🇲🇽 Мексика</div>
                                    <div class="country-option" data-country="TR" data-tier="2">🇹🇷 Турция</div>
                                    <div class="country-option" data-country="AR" data-tier="2">🇦🇷 Аргентина</div>
                                    <div class="country-option" data-country="CL" data-tier="2">🇨🇱 Чили</div>
                                    <div class="country-option" data-country="CO" data-tier="2">🇨🇴 Колумбия</div>
                                    <div class="country-option" data-country="PE" data-tier="2">🇵🇪 Перу</div>
                                    <div class="country-option" data-country="VE" data-tier="2">🇻🇪 Венесуэла</div>
                                    <div class="country-option" data-country="UY" data-tier="2">🇺🇾 Уругвай</div>
                                    <div class="country-option" data-country="EC" data-tier="2">🇪🇨 Эквадор</div>
                                    <div class="country-option" data-country="BO" data-tier="2">🇧🇴 Боливия</div>
                                    <div class="country-option" data-country="PY" data-tier="2">🇵🇾 Парагвай</div>
                                    <div class="country-option" data-country="ZA" data-tier="2">🇿🇦 ЮАР</div>
                                </div>
                                <div class="mb-2">
                                    <strong class="text-danger">Tier 3 - Экономичные страны</strong>
                                    <div class="country-option" data-country="NG" data-tier="3">🇳🇬 Нигерия</div>
                                    <div class="country-option" data-country="KE" data-tier="3">🇰🇪 Кения</div>
                                    <div class="country-option" data-country="GH" data-tier="3">🇬🇭 Гана</div>
                                    <div class="country-option" data-country="UG" data-tier="3">🇺🇬 Уганда</div>
                                    <div class="country-option" data-country="TZ" data-tier="3">🇹🇿 Танзания</div>
                                    <div class="country-option" data-country="ET" data-tier="3">🇪🇹 Эфиопия</div>
                                    <div class="country-option" data-country="MZ" data-tier="3">🇲🇿 Мозамбик</div>
                                    <div class="country-option" data-country="ZW" data-tier="3">🇿🇼 Зимбабве</div>
                                    <div class="country-option" data-country="ZM" data-tier="3">🇿🇲 Замбия</div>
                                    <div class="country-option" data-country="MW" data-tier="3">🇲🇼 Малави</div>
                                    <div class="country-option" data-country="BW" data-tier="3">🇧🇼 Ботсвана</div>
                                    <div class="country-option" data-country="NAM" data-tier="3">🇳🇦 Намибия</div>
                                    <div class="country-option" data-country="VN" data-tier="3">🇻🇳 Вьетнам</div>
                                    <div class="country-option" data-country="PH" data-tier="3">🇵🇭 Филиппины</div>
                                    <div class="country-option" data-country="EG" data-tier="3">🇪🇬 Египет</div>
                                    <div class="country-option" data-country="PK" data-tier="3">🇵🇰 Пакистан</div>
                                    <div class="country-option" data-country="BD" data-tier="3">🇧🇩 Бангладеш</div>
                                    <div class="country-option" data-country="LK" data-tier="3">🇱🇰 Шри-Ланка</div>
                                    <div class="country-option" data-country="NP" data-tier="3">🇳🇵 Непал</div>
                                    <div class="country-option" data-country="MM" data-tier="3">🇲🇲 Мьянма</div>
                                    <div class="country-option" data-country="KH" data-tier="3">🇰🇭 Камбоджа</div>
                                    <div class="country-option" data-country="LA" data-tier="3">🇱🇦 Лаос</div>
                                    <div class="country-option" data-country="MN" data-tier="3">🇲🇳 Монголия</div>
                                </div>
                                <div class="mb-2">
                                    <strong class="text-dark">Сложные страны</strong>
                                    <div class="country-option" data-country="AF" data-tier="difficult">🇦🇫 Афганистан</div>
                                    <div class="country-option" data-country="IR" data-tier="difficult">🇮🇷 Иран</div>
                                    <div class="country-option" data-country="IQ" data-tier="difficult">🇮🇶 Ирак</div>
                                    <div class="country-option" data-country="SY" data-tier="difficult">🇸🇾 Сирия</div>
                                    <div class="country-option" data-country="LB" data-tier="difficult">🇱🇧 Ливан</div>
                                    <div class="country-option" data-country="JO" data-tier="difficult">🇯🇴 Иордания</div>
                                    <div class="country-option" data-country="PS" data-tier="difficult">🇵🇸 Палестина</div>
                                    <div class="country-option" data-country="YE" data-tier="difficult">🇾🇪 Йемен</div>
                                    <div class="country-option" data-country="OM" data-tier="difficult">🇴🇲 Оман</div>
                                    <div class="country-option" data-country="KW" data-tier="difficult">🇰🇼 Кувейт</div>
                                    <div class="country-option" data-country="QA" data-tier="difficult">🇶🇦 Катар</div>
                                    <div class="country-option" data-country="BH" data-tier="difficult">🇧🇭 Бахрейн</div>
                                    <div class="country-option" data-country="AE" data-tier="difficult">🇦🇪 ОАЭ</div>
                                    <div class="country-option" data-country="SA" data-tier="difficult">🇸🇦 Саудовская Аравия</div>
                                    <div class="country-option" data-country="UA" data-tier="difficult">🇺🇦 Украина</div>
                                </div>
                            </div>
                            <small class="text-muted">Выберите одну или несколько стран для продвижения</small>
                        </div>
                    </div>

                    <!-- Правая колонка -->
                    <div class="col-lg-6">
                        <h4><i class="bi bi-tags"></i> Скидки и надбавки</h4>
                        
                        <div class="mb-3">
                            <label class="form-label"><strong>Скидки</strong></label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="own_badge" name="own_badge">
                                <label class="form-check-label" for="own_badge">Свой бейдж (-3%)</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="own_content" name="own_content">
                                <label class="form-check-label" for="own_content">Свой контент (-15%)</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="pilot" name="pilot">
                                <label class="form-check-label" for="pilot">Пилотный проект (-10%)</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="vip_discount" class="form-label"><strong>VIP скидка</strong></label>
                            <select class="form-select" id="vip_discount" name="vip_discount">
                                <option value="0">0%</option>
                                <option value="3">3%</option>
                                <option value="5">5%</option>
                                <option value="10">10%</option>
                                <option value="15">15%</option>
                            </select>
                        </div>

                        <h4><i class="bi bi-plus-circle"></i> Дополнительные услуги</h4>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="difficult_country" name="difficult_country">
                            <label class="form-check-label" for="difficult_country">Сложная страна (+30%)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="urgency" name="urgency">
                            <label class="form-check-label" for="urgency">Срочность (+40%)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="peak_season" name="peak_season">
                            <label class="form-check-label" for="peak_season">Пиковый сезон (+25%)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="exclusive_content" name="exclusive_content">
                            <label class="form-check-label" for="exclusive_content">Эксклюзивный контент (+35%)</label>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-primary" id="calculateBtn">
                        <i class="bi bi-calculator"></i> Рассчитать
                    </button>
                    <button type="button" class="btn btn-secondary" id="resetForm">
                        <i class="bi bi-arrow-clockwise"></i> Сбросить
                    </button>
                </div>
            </form>
        </div>

        <!-- Результаты -->
        <div class="result-section" id="resultBlock" style="display:none;">
            <h3 class="text-center mb-4"><i class="bi bi-graph-up"></i> Результаты расчета</h3>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h5 text-primary">Объем просмотров</div>
                        <div class="h3" id="res_views">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h5 text-success">Цена за просмотр</div>
                        <div class="h3" id="res_cpv">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h5 text-warning">Множитель по стране</div>
                        <div class="h3" id="res_multiplier">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h5 text-info">Рыночная скидка</div>
                        <div class="h3" id="res_market_discount">-</div>
                    </div>
                </div>
            </div>
            
            <!-- Новая секция с ценами по CPM и итоговыми ценами -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h5 text-primary">CPM (за 1000 просмотров)</div>
                        <div class="h3" id="res_cpm">-</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h5 text-success">Цена за просмотр со скидками</div>
                        <div class="h3" id="res_cpv_final">-</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h5 text-warning">CPM со скидками</div>
                        <div class="h3" id="res_cpm_final">-</div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4" id="platform_multiplier_row" style="display:none;">
                <div class="col-md-6 offset-md-3">
                    <div class="text-center">
                        <div class="h5 text-danger" id="res_platform_multiplier_label">Множитель платформы</div>
                        <div class="h3" id="res_platform_multiplier">-</div>
                    </div>
                </div>
            </div>

            <div class="accordion mb-4" id="resultAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMarkups">
                            <i class="bi bi-plus-circle"></i> Надбавки
                        </button>
                    </h2>
                    <div id="collapseMarkups" class="accordion-collapse collapse show">
                        <div class="accordion-body">
                            <div id="res_markups"></div>
                            <div class="mt-2">
                                <strong>Общая сумма надбавок: <span id="res_markup_amount">-</span></strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDiscounts">
                            <i class="bi bi-dash-circle"></i> Скидки
                        </button>
                    </h2>
                    <div id="collapseDiscounts" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div id="res_discounts"></div>
                            <div class="mt-2">
                                <strong>Общая сумма скидок: <span id="res_discount_amount">-</span></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="final-cost">
                <div class="h4 mb-2">Итоговая стоимость</div>
                <div class="h1" id="res_final_cost">-</div>
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-success me-2" id="saveCalc">
                    <i class="bi bi-save"></i> Сохранить расчет
                </button>
                <button class="btn btn-info me-2" id="copySummary">
                    <i class="bi bi-clipboard"></i> Копировать
                </button>
                <a class="btn btn-primary me-2" id="downloadExcel" href="#" style="display:none;" data-loading-text="Готовим Excel...">
                    <span class="btn-label"><i class="bi bi-file-earmark-excel"></i> Скачать Excel</span>
                    <span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display:none;"></span>
                </a>
                <a class="btn btn-secondary" href="{% url 'cabinet_export_calculations_csv' %}">
                    <i class="bi bi-file-earmark-csv"></i> Экспорт всех расчетов (CSV)
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
        // Константы (точно как в PHP версии)
        const BASE_TARIFFS = {
            15000000: 0.055,
            30000000: 0.050,
            50000000: 0.045,
            100000000: 0.040
        };
        
        const COUNTRY_MULTIPLIERS = {
            1: 1.0,    // Tier1 - базовая цена
            2: 0.85,   // Tier2 - скидка 15%
            3: 0.7,    // Tier3 - скидка 30%
            'difficult': 1.0  // Сложные страны - базовая цена (100%)
        };
        
        const MARKET_DISCOUNTS = {
            50000000: 5,      // 50 млн+ - скидка 5%
            100000000: 10,    // 100 млн+ - скидка 10%
            200000000: 15,    // 200 млн+ - скидка 15%
            500000000: 20     // 500 млн+ - скидка 20%
        };
        
        const DISCOUNTS = {
            'own_badge': 3,
            'own_content': 15,
            'pilot': 10
        };
        
        const MARKUPS = {
            'difficult_country': 30,
            'urgency': 40,
            'peak_season': 25,
            'exclusive_content': 35
        };
        
        // Курсы валют по ЦБ РФ (актуальные на 2025 год)
        const usdToRub = 92.5;  // 1 USD = 92.5 RUB
        const eurToRub = 100.8; // 1 EUR = 100.8 RUB
        
        // Выбранные страны
        let selectedCountries = [];
        
        function getCookie(name){
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            initializeCountrySelection();
            initializeEventHandlers();
            calculate();
        });
        
        function initializeCountrySelection() {
            document.querySelectorAll('.country-option').forEach(element => {
                element.addEventListener('click', function() {
                    const country = this.dataset.country;
                    const tier = this.dataset.tier;
                    
                    if (this.classList.contains('selected')) {
                        this.classList.remove('selected');
                        selectedCountries = selectedCountries.filter(c => c.code !== country);
                    } else {
                        this.classList.add('selected');
                        selectedCountries.push({ code: country, tier: tier });
                    }
                    
                    calculate();
                });
            });
        }
        
        function initializeEventHandlers() {
            // Синхронизация слайдера и поля ввода
            document.getElementById('views_mln').addEventListener('input', function() {
                document.getElementById('views_slider').value = this.value;
                calculate();
            });
            
            document.getElementById('views_slider').addEventListener('input', function() {
                document.getElementById('views_mln').value = this.value;
                calculate();
            });
            
            // Пересчет при изменении любых полей
            document.querySelectorAll('#calcForm input, #calcForm select').forEach(element => {
                element.addEventListener('change', calculate);
            });
            
            // Кнопки
            document.getElementById('calculateBtn').addEventListener('click', calculate);
            document.getElementById('resetForm').addEventListener('click', resetForm);
            document.getElementById('saveCalc').addEventListener('click', saveCalculation);
            document.getElementById('copySummary').addEventListener('click', copySummary);
        }
        
        function calculate() {
            const views_mln = parseFloat(document.getElementById('views_mln').value) || 0;
            const views = views_mln * 1000000;
            
            if (views_mln < 15) {
                document.getElementById('resultBlock').style.display = 'none';
                return;
            }
            
            if (!document.getElementById('platform_instagram').checked && 
                !document.getElementById('platform_tiktok').checked && 
                !document.getElementById('platform_youtube_shorts').checked) {
                return;
            }
            
            // Базовый расчет
            const basePrice = getBasePrice(views);
            const baseCost = views * basePrice;
            
            // Множитель по странам
            const countryMultiplier = getCountryMultiplier();
            const adjustedCost = baseCost * countryMultiplier;
            
            // Рыночная скидка
            const marketDiscount = getMarketDiscount(views);
            const marketDiscountAmount = adjustedCost * (marketDiscount / 100);
            const costAfterMarketDiscount = adjustedCost - marketDiscountAmount;
            
            // Множитель по платформам
            const platformMultiplier = getPlatformMultiplier();
            const costAfterPlatform = costAfterMarketDiscount * platformMultiplier;
            
            // Скидки
            const { discountPercent, discountList } = calculateDiscounts();
            const discountAmount = costAfterPlatform * (discountPercent / 100);
            const costAfterDiscounts = costAfterPlatform - discountAmount;
            
            // Надбавки
            const { markupPercent, markupList } = calculateMarkups();
            const markupAmount = costAfterDiscounts * (markupPercent / 100);
            const finalCost = costAfterDiscounts + markupAmount;
            
            // Конвертация валюты
            const currency = document.getElementById('currency').value;
            const { symbol, convertedCost } = convertCurrency(finalCost, currency);
            
            // Отображение результатов
            displayResults(views_mln, basePrice, countryMultiplier, marketDiscount, 
                         platformMultiplier, discountAmount, markupAmount, convertedCost, symbol, 
                         discountList, markupList, currency);
        }
        
        function getBasePrice(views) {
            if (views >= 100000000) return 0.040;
            if (views >= 50000000) return 0.045;
            if (views >= 30000000) return 0.050;
            if (views >= 15000000) return 0.055;
            return 0.055;
        }
        
        function getCountryMultiplier() {
            if (selectedCountries.length === 0) return 1.0;
            
            const avgTier = selectedCountries.reduce((sum, country) => {
                // Обрабатываем как числовые, так и строковые тиры
                if (country.tier === 'difficult') return sum + 4; // Присваиваем числовое значение для сложных стран
                return sum + parseInt(country.tier);
            }, 0) / selectedCountries.length;
            
            const tier = Math.round(avgTier);
            
            // Маппинг для числовых тиров
            if (tier === 4) return COUNTRY_MULTIPLIERS['difficult']; // Сложные страны
            return COUNTRY_MULTIPLIERS[tier] || 1.0;
        }
        
        function getMarketDiscount(views) {
            const sortedDiscounts = Object.entries(MARKET_DISCOUNTS).sort((a, b) => parseInt(b[0]) - parseInt(a[0]));
            for (const [minViews, discount] of sortedDiscounts) {
                if (views >= parseInt(minViews)) {
                    return discount;
                }
            }
            return 0;
        }
        
        function getPlatformMultiplier() {
            let multiplier = 1.0;
            
            if (document.getElementById('platform_youtube_shorts').checked) {
                multiplier = 1.15; // YouTube Shorts +15%
            }
            
            return multiplier;
        }
        
        function calculateDiscounts() {
            let totalDiscount = 0;
            let discountList = [];
            
            for (const [key, discount] of Object.entries(DISCOUNTS)) {
                const element = document.getElementById(key);
                if (element && element.checked) {
                    totalDiscount += discount;
                    discountList.push(`<div class="d-flex justify-content-between"><span>${getDiscountName(key)}</span><span class="text-success">-${discount}%</span></div>`);
                }
            }
            
            const vipDiscount = parseFloat(document.getElementById('vip_discount').value) || 0;
            if (vipDiscount > 0) {
                totalDiscount += vipDiscount;
                discountList.push(`<div class="d-flex justify-content-between"><span>VIP скидка</span><span class="text-success">-${vipDiscount}%</span></div>`);
            }
            
            return { discountPercent: totalDiscount, discountList };
        }
        
        function calculateMarkups() {
            let totalMarkup = 0;
            let markupList = [];
            
            for (const [key, markup] of Object.entries(MARKUPS)) {
                const element = document.getElementById(key);
                if (element && element.checked) {
                    totalMarkup += markup;
                    markupList.push(`<div class="d-flex justify-content-between"><span>${getMarkupName(key)}</span><span class="text-danger">+${markup}%</span></div>`);
                }
            }
            
            return { markupPercent: totalMarkup, markupList };
        }
        
        function getDiscountName(key) {
            const names = {
                'own_badge': 'Свой бейдж',
                'own_content': 'Свой контент',
                'pilot': 'Пилотный проект'
            };
            return names[key] || key;
        }
        
        function getMarkupName(key) {
            const names = {
                'difficult_country': 'Сложная страна',
                'urgency': 'Срочность',
                'peak_season': 'Пиковый сезон',
                'exclusive_content': 'Эксклюзивный контент'
            };
            return names[key] || key;
        }
        
        function convertCurrency(amount, currency) {
            let symbol = ' ₽';
            let convertedAmount = amount;
            
            if (currency === 'USD') {
                convertedAmount = amount / usdToRub;
                symbol = ' $';
            } else if (currency === 'EUR') {
                convertedAmount = amount / eurToRub;
                symbol = ' €';
            }
            
            return { symbol, convertedCost: convertedAmount };
        }
        
        function displayResults(views_mln, basePrice, countryMultiplier, marketDiscount, 
                               platformMultiplier, discountAmount, markupAmount, finalCost, symbol, 
                               discountList, markupList, currency) {
            
            document.getElementById('res_views').textContent = views_mln.toLocaleString('ru-RU') + ' млн';
            
            // Конвертируем цену за просмотр в выбранную валюту
            const { symbol: cpvSymbol, convertedCost: cpvCost } = convertCurrency(basePrice, currency);
            document.getElementById('res_cpv').textContent = cpvCost.toFixed(4) + cpvSymbol;
            
            // Рассчитываем CPM (цена за 1000 просмотров)
            const cpm = cpvCost * 1000;
            document.getElementById('res_cpm').textContent = cpm.toFixed(2) + cpvSymbol;
            
            // Рассчитываем итоговую цену за 1 просмотр со всеми скидками и надбавками
            const finalCostPerView = finalCost / (views_mln * 1000000);
            document.getElementById('res_cpv_final').textContent = finalCostPerView.toFixed(4) + symbol;
            
            // Рассчитываем итоговый CPM со скидками
            const finalCpm = finalCostPerView * 1000;
            document.getElementById('res_cpm_final').textContent = finalCpm.toFixed(2) + symbol;
            
            document.getElementById('res_multiplier').textContent = (countryMultiplier * 100).toFixed(0) + '%';
            document.getElementById('res_market_discount').textContent = marketDiscount + '%';
            
            // Добавляем информацию о множителе платформы
            if (platformMultiplier > 1.0) {
                document.getElementById('res_platform_multiplier').textContent = '+' + ((platformMultiplier - 1) * 100).toFixed(0) + '%';
                document.getElementById('platform_multiplier_row').style.display = 'block';
            } else {
                document.getElementById('platform_multiplier_row').style.display = 'none';
            }
            
            // Конвертируем суммы надбавок и скидок в выбранную валюту
            const { symbol: markupSymbol, convertedCost: markupConverted } = convertCurrency(markupAmount, currency);
            const { symbol: discountSymbol, convertedCost: discountConverted } = convertCurrency(discountAmount, currency);
            
            document.getElementById('res_markup_amount').textContent = markupConverted.toFixed(2) + markupSymbol;
            document.getElementById('res_discount_amount').textContent = discountConverted.toFixed(2) + discountSymbol;
            document.getElementById('res_final_cost').textContent = finalCost.toFixed(2) + symbol;
            
            document.getElementById('res_markups').innerHTML = markupList.length > 0 ? markupList.join('') : '<div class="text-muted">Нет надбавок</div>';
            document.getElementById('res_discounts').innerHTML = discountList.length > 0 ? discountList.join('') : '<div class="text-muted">Нет скидок</div>';
            
            document.getElementById('resultBlock').style.display = 'block';
        }
        
        function resetForm() {
            document.getElementById('calcForm').reset();
            document.getElementById('views_slider').value = 15;
            document.querySelectorAll('.country-option').forEach(el => el.classList.remove('selected'));
            selectedCountries = [];
            document.getElementById('resultBlock').style.display = 'none';
            calculate();
        }
        
        async function saveCalculation() {
            // Определяем выбранные платформы
            const platforms = [];
            if (document.getElementById('platform_instagram').checked) platforms.push('instagram');
            if (document.getElementById('platform_tiktok').checked) platforms.push('tiktok');
            if (document.getElementById('platform_youtube_shorts').checked) platforms.push('youtube_shorts');
            
            // Определяем основную страну для API (первая выбранная)
            const primaryCountry = selectedCountries.length > 0 ? selectedCountries[0].code : 'USA';
            
            const calculationData = {
                volume_millions: parseFloat(document.getElementById('views_mln').value) || 0,
                platform: platforms.length > 0 ? platforms[0] : 'instagram', // Основная платформа для API
                platforms: platforms, // Все выбранные платформы
                country: primaryCountry, // Основная страна для API
                countries: selectedCountries, // Все выбранные страны
                currency: document.getElementById('currency').value,
                own_badge: document.getElementById('own_badge').checked,
                own_content: document.getElementById('own_content').checked,
                pilot: document.getElementById('pilot').checked,
                vip_percent: parseInt(document.getElementById('vip_discount').value) / 100.0 || 0,
                urgent: document.getElementById('urgency').checked,
                peak_season: document.getElementById('peak_season').checked,
                exclusive_content: document.getElementById('exclusive_content').checked,
                notes: 'Расчет сохранен автоматически'
            };
            
            try {
                const response = await fetch('{% url "cabinet_agency_calc_quote" %}', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(calculationData)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showNotification('Расчет сохранен', 'success');
                    // Показываем кнопку скачивания
                    if (result.calculation_id) {
                        const downloadBtn = document.getElementById('downloadExcel');
                        downloadBtn.href = `/cabinet/download/calculation/${result.calculation_id}/excel/`;
                        downloadBtn.style.display = 'inline-block';
                        // bind loading indicator
                        if (!downloadBtn.dataset.bound) {
                            downloadBtn.addEventListener('click', function(e){
                                const spinner = this.querySelector('.spinner-border');
                                const label = this.querySelector('.btn-label');
                                if (spinner && label) {
                                    spinner.style.display = 'inline-block';
                                    label.textContent = 'Готовим Excel...';
                                    // Hide spinner after download starts (best effort)
                                    setTimeout(()=>{
                                        spinner.style.display = 'none';
                                        label.innerHTML = '\\u003ci class="bi bi-file-earmark-excel"\\u003e\\u003c/i\\u003e Скачать Excel';
                                    }, 6000);
                                }
                            });
                            downloadBtn.dataset.bound = '1';
                        }
                    }
                } else {
                    showNotification('Ошибка сохранения: ' + (result.error || 'Неизвестная ошибка'), 'error');
                }
            } catch (e) {
                showNotification('Ошибка соединения', 'error');
            }
        }
        
        function copySummary() {
            const summary = `Расчет стоимости продвижения: ${document.getElementById('res_views').textContent} просмотров, итоговая стоимость: ${document.getElementById('res_final_cost').textContent}`;
            navigator.clipboard.writeText(summary).then(() => {
                showNotification('Скопировано в буфер обмена', 'success');
            }).catch(() => {
                showNotification('Ошибка копирования', 'error');
            });
        }
        
        function showNotification(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} notification`;
            notification.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
</script>
{% endblock %}
